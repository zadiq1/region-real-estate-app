<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Property Management</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .upload-box {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .upload-box.dragover {
      border-color: #00b894;
      background-color: #f0fff4;
    }
    .preview {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .preview img {
      width: 120px;
      height: 80px;
      object-fit: cover;
      border: 1px solid #ccc;
    }
    .progress {
      width: 100%;
      background: #eee;
      margin: 4px 0;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: #00b894;
      width: 0%;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Admin Dashboard</h1>
    </div>
  </header>

  <main class="container">
    <h2>Add New Property</h2>

    <label>Title:</label>
    <input type="text" id="title" placeholder="Property title" /><br><br>

    <label>Description:</label>
    <textarea id="description" placeholder="Property description"></textarea><br><br>

    <label>Price:</label>
    <input type="number" id="price" /><br><br>

    <label>Type:</label>
    <select id="type">
      <option value="buy">Buy</option>
      <option value="rent">Rent</option>
      <option value="apartment">Apartment</option>
    </select><br><br>

    <h3>Upload Images</h3>
    <div id="imageDrop" class="upload-box">Drag & Drop Images or Click</div>
    <div id="imagePreview" class="preview"></div>

    <h3>Upload Videos</h3>
    <div id="videoDrop" class="upload-box">Drag & Drop Videos or Click</div>
    <div id="videoPreview" class="preview"></div>

    <button id="saveProperty">Save Property</button>
    <p id="status"></p>
  </main>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

    // âœ… Your Firebase Config
   const firebaseConfig = {
  apiKey: "AIzaSyAAoPIw61ZsZB8C7zH4183yWUqh44uwbgA",
  authDomain: "dreamspace-8f29c.firebaseapp.com",
  projectId: "dreamspace-8f29c",
  storageBucket: "dreamspace-8f29c.firebasestorage.app",
  messagingSenderId: "828857686522",
  appId: "1:828857686522:web:35af98d58532393029ac43",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let imageFiles = [];
    let videoFiles = [];

    function handleDropArea(dropArea, fileArray, previewContainer, type) {
      dropArea.addEventListener("click", () => {
        let input = document.createElement("input");
        input.type = "file";
        input.multiple = true;
        input.accept = type === "image" ? "image/*" : "video/*";
        input.onchange = (e) => {
          for (let file of e.target.files) {
            fileArray.push(file);
            showPreview(file, previewContainer);
          }
        };
        input.click();
      });

      dropArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropArea.classList.add("dragover");
      });

      dropArea.addEventListener("dragleave", () => {
        dropArea.classList.remove("dragover");
      });

      dropArea.addEventListener("drop", (e) => {
        e.preventDefault();
        dropArea.classList.remove("dragover");
        for (let file of e.dataTransfer.files) {
          fileArray.push(file);
          showPreview(file, previewContainer);
        }
      });
    }

    function showPreview(file, container) {
      let reader = new FileReader();
      reader.onload = (e) => {
        if (file.type.startsWith("image/")) {
          let img = document.createElement("img");
          img.src = e.target.result;
          container.appendChild(img);
        } else if (file.type.startsWith("video/")) {
          let vid = document.createElement("video");
          vid.src = e.target.result;
          vid.width = 120;
          vid.height = 80;
          vid.controls = true;
          container.appendChild(vid);
        }
      };
      reader.readAsDataURL(file);
    }

    async function uploadFiles(files, folder) {
      let urls = [];
      for (let file of files) {
        let fileRef = ref(storage, `${folder}/${Date.now()}-${file.name}`);
        let uploadTask = uploadBytesResumable(fileRef, file);

        await new Promise((resolve, reject) => {
          uploadTask.on("state_changed", 
            (snapshot) => {
              let progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              console.log(file.name, progress + "%");
            }, 
            (error) => reject(error),
            async () => {
              let downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
              urls.push(downloadURL);
              resolve();
            }
          );
        });
      }
      return urls;
    }

    document.getElementById("saveProperty").addEventListener("click", async () => {
      const title = document.getElementById("title").value;
      const description = document.getElementById("description").value;
      const price = parseFloat(document.getElementById("price").value);
      const type = document.getElementById("type").value;

      if (!title || !description || !price) {
        alert("Please fill all details");
        return;
      }

      document.getElementById("status").innerText = "Uploading files...";

      const imageUrls = await uploadFiles(imageFiles, "images");
      const videoUrls = await uploadFiles(videoFiles, "videos");

      await addDoc(collection(db, "listings"), {
        title, description, price, type,
        images: imageUrls,
        videos: videoUrls
      });

      document.getElementById("status").innerText = "Property saved successfully!";
      imageFiles = [];
      videoFiles = [];
    });

    handleDropArea(document.getElementById("imageDrop"), imageFiles, document.getElementById("imagePreview"), "image");
    handleDropArea(document.getElementById("videoDrop"), videoFiles, document.getElementById("videoPreview"), "video");
  </script>
</body>
</html>
